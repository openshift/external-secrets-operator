apiVersion: apiextensions.k8s.io/v1 # Hack because controller-gen complains if we don't have this
name: "ExternalSecretsConfig"
crdName: externalsecretsconfigs.operator.openshift.io
tests:
  onCreate:
    - name: Should be able to create a minimal ExternalSecretsConfig instance
      resourceName: cluster
      initial: |
        apiVersion: operator.openshift.io/v1alpha1
        kind: ExternalSecretsConfig
        spec: {} # No spec is required for a ExternalSecretsConfig
      expected: |
        apiVersion: operator.openshift.io/v1alpha1
        kind: ExternalSecretsConfig
        spec: {}
    - name: Should be able to create ExternalSecretsConfig with ControllerConfig spec
      resourceName: cluster
      initial: |
        apiVersion: operator.openshift.io/v1alpha1
        kind: ExternalSecretsConfig
        spec:
          controllerConfig:
            labels:
              "app": "external-secrets"
      expected: |
        apiVersion: operator.openshift.io/v1alpha1
        kind: ExternalSecretsConfig
        spec:
          controllerConfig:
            labels:
              "app": "external-secrets"
    - name: Should be able to create ExternalSecretsConfig with ApplicationConfig spec
      resourceName: cluster
      initial: |
        apiVersion: operator.openshift.io/v1alpha1
        kind: ExternalSecretsConfig
        spec:
          appConfig:
            operatingNamespace: "test-namespace"
            logLevel: 3
            webhookConfig:
              certificateCheckInterval: "10m"
          plugins:
            bitwardenSecretManagerProvider:
              mode: Enabled
              secretRef:
                name: "bitwarden-tls-certs"
      expected: |
        apiVersion: operator.openshift.io/v1alpha1
        kind: ExternalSecretsConfig
        spec:
          appConfig:
            operatingNamespace: "test-namespace"
            logLevel: 3
            webhookConfig:
              certificateCheckInterval: "10m"
          plugins:
            bitwardenSecretManagerProvider:
              mode: Enabled
              secretRef:
                name: "bitwarden-tls-certs"
    - name: Should be able to create ExternalSecretsConfig with cert-manager configuration
      resourceName: cluster
      initial: |
        apiVersion: operator.openshift.io/v1alpha1
        kind: ExternalSecretsConfig
        spec:
          controllerConfig:
            certProvider:
              certManager:
                mode: Enabled
                issuerRef:
                  name: "letsencrypt-issuer"
                  kind: "ClusterIssuer"
                  group: "cert-manager.io"
                injectAnnotations: "true"
      expected: |
        apiVersion: operator.openshift.io/v1alpha1
        kind: ExternalSecretsConfig
        spec:
          controllerConfig:
            certProvider:
              certManager:
                mode: Enabled
                issuerRef:
                  name: "letsencrypt-issuer"
                  kind: "ClusterIssuer"
                  group: "cert-manager.io"
                injectAnnotations: "true"
                certificateDuration: "8760h"
                certificateRenewBefore: "30m"
    - name: Should fail to create with invalid singleton name
      resourceName: not-cluster
      initial: |
        apiVersion: operator.openshift.io/v1alpha1
        kind: ExternalSecretsConfig
        spec: {}
      expectedError: "ExternalSecretsConfig.operator.openshift.io \"not-cluster\" is invalid: <nil>: Invalid value: \"object\": ExternalSecretsConfig is a singleton, .metadata.name must be 'cluster'"
    - name: Should fail to create cert-manager enabled without issuerRef
      resourceName: cluster
      initial: |
        apiVersion: operator.openshift.io/v1alpha1
        kind: ExternalSecretsConfig
        spec:
          controllerConfig:
            certProvider:
              certManager:
                mode: Enabled
      expectedError: "ExternalSecretsConfig.operator.openshift.io \"cluster\" is invalid: spec.controllerConfig.certProvider.certManager: Invalid value: \"object\": issuerRef must be provided when mode is set to Enabled."
    - name: Should fail with injectAnnotations without cert-manager enabled
      resourceName: cluster
      initial: |
        apiVersion: operator.openshift.io/v1alpha1
        kind: ExternalSecretsConfig
        spec:
          controllerConfig:
            certProvider:
              certManager:
                mode: Disabled
                injectAnnotations: "true"
      expectedError: "ExternalSecretsConfig.operator.openshift.io \"cluster\" is invalid: spec.controllerConfig.certProvider.certManager: Invalid value: \"object\": injectAnnotations can only be set when mode is set to Enabled."
    - name: Should fail with injectAnnotations true when mode is Disabled explicitly
      resourceName: cluster
      initial: |
        apiVersion: operator.openshift.io/v1alpha1
        kind: ExternalSecretsConfig
        spec:
          controllerConfig:
            certProvider:
              certManager:
                mode: Disabled
                injectAnnotations: "true"
                issuerRef:
                  name: "test-issuer"
                  kind: "ClusterIssuer"
                  group: "cert-manager.io"
      expectedError: "ExternalSecretsConfig.operator.openshift.io \"cluster\" is invalid: spec.controllerConfig.certProvider.certManager: Invalid value: \"object\": injectAnnotations can only be set when mode is set to Enabled."
    - name: Should allow injectAnnotations false when mode is Disabled
      resourceName: cluster
      initial: |
        apiVersion: operator.openshift.io/v1alpha1
        kind: ExternalSecretsConfig
        spec:
          controllerConfig:
            certProvider:
              certManager:
                mode: Disabled
                injectAnnotations: "false"
      expected: |
        apiVersion: operator.openshift.io/v1alpha1
        kind: ExternalSecretsConfig
        spec:
          controllerConfig:
            certProvider:
              certManager:
                mode: Disabled
                injectAnnotations: "false"
                certificateDuration: "8760h"
                certificateRenewBefore: "30m"
    - name: Should allow omitting injectAnnotations when mode is Disabled
      resourceName: cluster
      initial: |
        apiVersion: operator.openshift.io/v1alpha1
        kind: ExternalSecretsConfig
        spec:
          controllerConfig:
            certProvider:
              certManager:
                mode: Disabled
      expected: |
        apiVersion: operator.openshift.io/v1alpha1
        kind: ExternalSecretsConfig
        spec:
          controllerConfig:
            certProvider:
              certManager:
                mode: Disabled
                certificateDuration: "8760h"
                certificateRenewBefore: "30m"
                injectAnnotations: "false"
    - name: Should fail with invalid issuer kind
      resourceName: cluster
      initial: |
        apiVersion: operator.openshift.io/v1alpha1
        kind: ExternalSecretsConfig
        spec:
          controllerConfig:
            certProvider:
              certManager:
                mode: Enabled
                issuerRef:
                  name: "test-issuer"
                  kind: "InvalidKind"
                  group: "cert-manager.io"
      expectedError: "ExternalSecretsConfig.operator.openshift.io \"cluster\" is invalid: spec.controllerConfig.certProvider.certManager.issuerRef: Invalid value: \"object\": kind must be either 'Issuer' or 'ClusterIssuer'"
    - name: Should fail with invalid issuer group
      resourceName: cluster
      initial: |
        apiVersion: operator.openshift.io/v1alpha1
        kind: ExternalSecretsConfig
        spec:
          controllerConfig:
            certProvider:
              certManager:
                mode: Enabled
                issuerRef:
                  name: "test-issuer"
                  kind: "ClusterIssuer"
                  group: "invalid-group"
      expectedError: "ExternalSecretsConfig.operator.openshift.io \"cluster\" is invalid: spec.controllerConfig.certProvider.certManager.issuerRef: Invalid value: \"object\": group must be 'cert-manager.io'"
    - name: Should fail with operatingNamespace too short
      resourceName: cluster
      initial: |
        apiVersion: operator.openshift.io/v1alpha1
        kind: ExternalSecretsConfig
        spec:
          appConfig:
            operatingNamespace: ""
      expectedError: "ExternalSecretsConfig.operator.openshift.io \"cluster\" is invalid: spec.appConfig.operatingNamespace: Invalid value: \"\": spec.appConfig.operatingNamespace in body should be at least 1 chars long"
    - name: Should fail with operatingNamespace too long
      resourceName: cluster
      initial: |
        apiVersion: operator.openshift.io/v1alpha1
        kind: ExternalSecretsConfig
        spec:
          appConfig:
            operatingNamespace: "this-namespace-name-is-way-too-long-and-exceeds-the-maximum-allowed-length-of-sixty-three-characters-total"
      expectedError: "ExternalSecretsConfig.operator.openshift.io \"cluster\" is invalid: [spec.appConfig.operatingNamespace: Too long: may not be more than 63 bytes, <nil>: Invalid value: \"null\": some validation rules were not checked because the object was invalid; correct the existing errors to complete validation]"
    - name: Should fail with too many controller labels
      resourceName: cluster
      initial: |
        apiVersion: operator.openshift.io/v1alpha1
        kind: ExternalSecretsConfig
        spec:
          controllerConfig:
            labels:
              "label-key-0": "label-value-0"
              "label-key-1": "label-value-1"
              "label-key-2": "label-value-2"
              "label-key-3": "label-value-3"
              "label-key-4": "label-value-4"
              "label-key-5": "label-value-5"
              "label-key-6": "label-value-6"
              "label-key-7": "label-value-7"
              "label-key-8": "label-value-8"
              "label-key-9": "label-value-9"
              "label-key-10": "label-value-10"
              "label-key-11": "label-value-11"
              "label-key-12": "label-value-12"
              "label-key-13": "label-value-13"
              "label-key-14": "label-value-14"
              "label-key-15": "label-value-15"
              "label-key-16": "label-value-16"
              "label-key-17": "label-value-17"
              "label-key-18": "label-value-18"
              "label-key-19": "label-value-19"
              "label-key-20": "label-value-20"
      expectedError: "ExternalSecretsConfig.operator.openshift.io \"cluster\" is invalid: [spec.controllerConfig.labels: Too many: 21: must have at most 20 items, <nil>: Invalid value: \"null\": some validation rules were not checked because the object was invalid; correct the existing errors to complete validation]"
    - name: Should fail with issuerRef name too long
      resourceName: cluster
      initial: |
        apiVersion: operator.openshift.io/v1alpha1
        kind: ExternalSecretsConfig
        spec:
          controllerConfig:
            certProvider:
              certManager:
                mode: Enabled
                issuerRef:
                  name: "this-issuer-name-is-extremely-long-and-exceeds-the-kubernetes-maximum-name-length-limit-of-two-hundred-fifty-three-characters-which-is-quite-a-lot-of-characters-but-we-need-to-test-this-validation-constraint-properly-to-ensure-it-works-as-expected-in-all-scenarios"
                  kind: "ClusterIssuer"
                  group: "cert-manager.io"
      expectedError: "ExternalSecretsConfig.operator.openshift.io \"cluster\" is invalid: [spec.controllerConfig.certProvider.certManager.issuerRef.name: Too long: may not be more than 253 bytes, <nil>: Invalid value: \"null\": some validation rules were not checked because the object was invalid; correct the existing errors to complete validation]"
    - name: Should fail with issuerRef name empty (required field)
      resourceName: cluster
      initial: |
        apiVersion: operator.openshift.io/v1alpha1
        kind: ExternalSecretsConfig
        spec:
          controllerConfig:
            certProvider:
              certManager:
                mode: Enabled
                issuerRef:
                  name: ""
                  kind: "ClusterIssuer"
                  group: "cert-manager.io"
      expectedError: "ExternalSecretsConfig.operator.openshift.io \"cluster\" is invalid: spec.controllerConfig.certProvider.certManager.issuerRef.name: Invalid value: \"\": spec.controllerConfig.certProvider.certManager.issuerRef.name in body should be at least 1 chars long"
    - name: Should fail with issuerRef kind too long
      resourceName: cluster
      initial: |
        apiVersion: operator.openshift.io/v1alpha1
        kind: ExternalSecretsConfig
        spec:
          controllerConfig:
            certProvider:
              certManager:
                mode: Enabled
                issuerRef:
                  name: "test-issuer"
                  kind: "this-kind-name-is-extremely-long-and-exceeds-the-kubernetes-maximum-name-length-limit-of-two-hundred-fifty-three-characters-which-is-quite-a-lot-of-characters-but-we-need-to-test-this-validation-constraint-properly-to-ensure-it-works-as-expected-in-all-scenarios"
                  group: "cert-manager.io"
      expectedError: "ExternalSecretsConfig.operator.openshift.io \"cluster\" is invalid: [spec.controllerConfig.certProvider.certManager.issuerRef.kind: Too long: may not be more than 253 bytes, <nil>: Invalid value: \"null\": some validation rules were not checked because the object was invalid; correct the existing errors to complete validation]"
    - name: Should fail with issuerRef group too long
      resourceName: cluster
      initial: |
        apiVersion: operator.openshift.io/v1alpha1
        kind: ExternalSecretsConfig
        spec:
          controllerConfig:
            certProvider:
              certManager:
                mode: Enabled
                issuerRef:
                  name: "test-issuer"
                  kind: "ClusterIssuer"
                  group: "this-group-name-is-extremely-long-and-exceeds-the-kubernetes-maximum-name-length-limit-of-two-hundred-fifty-three-characters-which-is-quite-a-lot-of-characters-but-we-need-to-test-this-validation-constraint-properly-to-ensure-it-works-as-expected-in-all-scenarios"
      expectedError: "ExternalSecretsConfig.operator.openshift.io \"cluster\" is invalid: [spec.controllerConfig.certProvider.certManager.issuerRef.group: Too long: may not be more than 253 bytes, <nil>: Invalid value: \"null\": some validation rules were not checked because the object was invalid; correct the existing errors to complete validation]"
    - name: Should fail with bitwarden secretRef name empty (required field)
      resourceName: cluster
      initial: |
        apiVersion: operator.openshift.io/v1alpha1
        kind: ExternalSecretsConfig
        spec:
          plugins:
            bitwardenSecretManagerProvider:
              mode: Enabled
              secretRef:
                name: ""
      expectedError: "ExternalSecretsConfig.operator.openshift.io \"cluster\" is invalid: spec.plugins.bitwardenSecretManagerProvider.secretRef.name: Invalid value: \"\": spec.plugins.bitwardenSecretManagerProvider.secretRef.name in body should be at least 1 chars long"
    - name: Should fail with bitwarden secretRef name too long
      resourceName: cluster
      initial: |
        apiVersion: operator.openshift.io/v1alpha1
        kind: ExternalSecretsConfig
        spec:
          plugins:
            bitwardenSecretManagerProvider:
              mode: Enabled
              secretRef:
                name: "this-secret-name-is-extremely-long-and-exceeds-the-kubernetes-maximum-name-length-limit-of-two-hundred-fifty-three-characters-which-is-quite-a-lot-of-characters-but-we-need-to-test-this-validation-constraint-properly-to-ensure-it-works-as-expected-in-all-scenarios"
      expectedError: "ExternalSecretsConfig.operator.openshift.io \"cluster\" is invalid: [spec.plugins.bitwardenSecretManagerProvider.secretRef.name: Too long: may not be more than 253 bytes, <nil>: Invalid value: \"null\": some validation rules were not checked because the object was invalid; correct the existing errors to complete validation]"
    - name: Should fail with invalid log level too low
      resourceName: cluster
      initial: |
        apiVersion: operator.openshift.io/v1alpha1
        kind: ExternalSecretsConfig
        spec:
          appConfig:
            logLevel: 0
      expectedError: "spec.appConfig.logLevel: Invalid value: 0: spec.appConfig.logLevel in body should be greater than or equal to 1"
    - name: Should fail with invalid log level too high
      resourceName: cluster
      initial: |
        apiVersion: operator.openshift.io/v1alpha1
        kind: ExternalSecretsConfig
        spec:
          appConfig:
            logLevel: 10
      expectedError: "ExternalSecretsConfig.operator.openshift.io \"cluster\" is invalid: spec.appConfig.logLevel: Invalid value: 10: spec.appConfig.logLevel in body should be less than or equal to 5"
    - name: Should fail with bitwarden enabled but no secretRef or cert-manager
      resourceName: cluster
      initial: |
        apiVersion: operator.openshift.io/v1alpha1
        kind: ExternalSecretsConfig
        spec:
          plugins:
            bitwardenSecretManagerProvider:
              mode: Enabled
      expectedError: "ExternalSecretsConfig.operator.openshift.io \"cluster\" is invalid: spec: Invalid value: \"object\": secretRef or certManager must be configured when bitwardenSecretManagerProvider plugin is enabled"
    - name: Should fail with bitwarden enabled and cert-manager disabled without secretRef
      resourceName: cluster
      initial: |
        apiVersion: operator.openshift.io/v1alpha1
        kind: ExternalSecretsConfig
        spec:
          plugins:
            bitwardenSecretManagerProvider:
              mode: Enabled
          controllerConfig:
            certProvider:
              certManager:
                mode: Disabled
      expectedError: "ExternalSecretsConfig.operator.openshift.io \"cluster\" is invalid: spec: Invalid value: \"object\": secretRef or certManager must be configured when bitwardenSecretManagerProvider plugin is enabled"
    - name: Should allow bitwarden enabled with both secretRef and cert-manager enabled
      resourceName: cluster
      initial: |
        apiVersion: operator.openshift.io/v1alpha1
        kind: ExternalSecretsConfig
        spec:
          plugins:
            bitwardenSecretManagerProvider:
              mode: Enabled
              secretRef:
                name: "bitwarden-tls-certs"
          controllerConfig:
            certProvider:
              certManager:
                mode: Enabled
                injectAnnotations: "false"
                issuerRef:
                  name: "letsencrypt-issuer"
                  kind: "ClusterIssuer"
                  group: "cert-manager.io"
      expected: |
        apiVersion: operator.openshift.io/v1alpha1
        kind: ExternalSecretsConfig
        spec:
          plugins:
            bitwardenSecretManagerProvider:
              mode: Enabled
              secretRef:
                name: "bitwarden-tls-certs"
          controllerConfig:
            certProvider:
              certManager:
                mode: Enabled
                injectAnnotations: "false"
                issuerRef:
                  name: "letsencrypt-issuer"
                  kind: "ClusterIssuer"
                  group: "cert-manager.io"
                certificateDuration: "8760h"
                certificateRenewBefore: "30m"
    - name: Should allow bitwarden enabled with cert-manager enabled but no secretRef
      resourceName: cluster
      initial: |
        apiVersion: operator.openshift.io/v1alpha1
        kind: ExternalSecretsConfig
        spec:
          plugins:
            bitwardenSecretManagerProvider:
              mode: Enabled
          controllerConfig:
            certProvider:
              certManager:
                mode: Enabled
                injectAnnotations: "false"
                issuerRef:
                  name: "letsencrypt-issuer"
                  kind: "ClusterIssuer"
                  group: "cert-manager.io"
      expected: |
        apiVersion: operator.openshift.io/v1alpha1
        kind: ExternalSecretsConfig
        spec:
          plugins:
            bitwardenSecretManagerProvider:
              mode: Enabled
          controllerConfig:
            certProvider:
              certManager:
                mode: Enabled
                injectAnnotations: "false"
                issuerRef:
                  name: "letsencrypt-issuer"
                  kind: "ClusterIssuer"
                  group: "cert-manager.io"
                certificateDuration: "8760h"
                certificateRenewBefore: "30m"
    - name: Should allow bitwarden disabled without secretRef or cert-manager
      resourceName: cluster
      initial: |
        apiVersion: operator.openshift.io/v1alpha1
        kind: ExternalSecretsConfig
        spec:
          plugins:
            bitwardenSecretManagerProvider:
              mode: Disabled
      expected: |
        apiVersion: operator.openshift.io/v1alpha1
        kind: ExternalSecretsConfig
        spec:
          plugins:
            bitwardenSecretManagerProvider:
              mode: Disabled
    - name: Should allow webhookConfig with custom certificateCheckInterval
      resourceName: cluster
      initial: |
        apiVersion: operator.openshift.io/v1alpha1
        kind: ExternalSecretsConfig
        spec:
          appConfig:
            webhookConfig:
              certificateCheckInterval: "15m"
            operatingNamespace: "test-ns"
      expected: |
        apiVersion: operator.openshift.io/v1alpha1
        kind: ExternalSecretsConfig
        spec:
          appConfig:
            logLevel: 1
            webhookConfig:
              certificateCheckInterval: "15m"
            operatingNamespace: "test-ns"
    - name: Should allow custom annotations in controllerConfig
      resourceName: cluster
      initial: |
        apiVersion: operator.openshift.io/v1alpha1
        kind: ExternalSecretsConfig
        spec:
          controllerConfig:
            annotations:
              custom.company.io/team: "platform"
              custom.company.io/app: "external-secrets"
      expected: |
        apiVersion: operator.openshift.io/v1alpha1
        kind: ExternalSecretsConfig
        spec:
          controllerConfig:
            annotations:
              custom.company.io/team: "platform"
              custom.company.io/app: "external-secrets"
    - name: Should fail with annotation key starting with kubernetes.io
      resourceName: cluster
      initial: |
        apiVersion: operator.openshift.io/v1alpha1
        kind: ExternalSecretsConfig
        spec:
          controllerConfig:
            annotations:
              kubernetes.io/service-account: "test"
      expectedError: "ExternalSecretsConfig.operator.openshift.io \"cluster\" is invalid: spec.controllerConfig.annotations: Invalid value: \"object\": Annotation keys containing reserved domains 'kubernetes.io/', 'openshift.io/', or 'k8s.io/' (including subdomains like '*.kubernetes.io/') are not allowed"
    - name: Should fail with annotation key starting with app.kubernetes.io
      resourceName: cluster
      initial: |
        apiVersion: operator.openshift.io/v1alpha1
        kind: ExternalSecretsConfig
        spec:
          controllerConfig:
            annotations:
              app.kubernetes.io/name: "test"
      expectedError: "ExternalSecretsConfig.operator.openshift.io \"cluster\" is invalid: spec.controllerConfig.annotations: Invalid value: \"object\": Annotation keys containing reserved domains 'kubernetes.io/', 'openshift.io/', or 'k8s.io/' (including subdomains like '*.kubernetes.io/') are not allowed"
    - name: Should fail with annotation key starting with openshift.io
      resourceName: cluster
      initial: |
        apiVersion: operator.openshift.io/v1alpha1
        kind: ExternalSecretsConfig
        spec:
          controllerConfig:
            annotations:
              openshift.io/cluster: "test"
      expectedError: "ExternalSecretsConfig.operator.openshift.io \"cluster\" is invalid: spec.controllerConfig.annotations: Invalid value: \"object\": Annotation keys containing reserved domains 'kubernetes.io/', 'openshift.io/', or 'k8s.io/' (including subdomains like '*.kubernetes.io/') are not allowed"
    - name: Should fail with annotation key starting with k8s.io
      resourceName: cluster
      initial: |
        apiVersion: operator.openshift.io/v1alpha1
        kind: ExternalSecretsConfig
        spec:
          controllerConfig:
            annotations:
              k8s.io/component: "test"
      expectedError: "ExternalSecretsConfig.operator.openshift.io \"cluster\" is invalid: spec.controllerConfig.annotations: Invalid value: \"object\": Annotation keys containing reserved domains 'kubernetes.io/', 'openshift.io/', or 'k8s.io/' (including subdomains like '*.kubernetes.io/') are not allowed"
    - name: Should not allow annotation key with subdomain of kubernetes.io
      resourceName: cluster
      initial: |
        apiVersion: operator.openshift.io/v1alpha1
        kind: ExternalSecretsConfig
        spec:
          controllerConfig:
            annotations:
              custom.kubernetes.io/annotation: "denied"
      expectedError: "ExternalSecretsConfig.operator.openshift.io \"cluster\" is invalid: spec.controllerConfig.annotations: Invalid value: \"object\": Annotation keys containing reserved domains 'kubernetes.io/', 'openshift.io/', or 'k8s.io/' (including subdomains like '*.kubernetes.io/') are not allowed"
    - name: Should allow annotation key ending with kubernetes.io
      resourceName: cluster
      initial: |
        apiVersion: operator.openshift.io/v1alpha1
        kind: ExternalSecretsConfig
        spec:
          controllerConfig:
            annotations:
              test-kubernetes.io/value: "allowed"
      expected: |
        apiVersion: operator.openshift.io/v1alpha1
        kind: ExternalSecretsConfig
        spec:
          controllerConfig:
            annotations:
              test-kubernetes.io/value: "allowed"
    - name: Should not allow annotation key with subdomain of k8s.io
      resourceName: cluster
      initial: |
        apiVersion: operator.openshift.io/v1alpha1
        kind: ExternalSecretsConfig
        spec:
          controllerConfig:
            annotations:
              service.k8s.io/annotation: "denied"
      expectedError: "ExternalSecretsConfig.operator.openshift.io \"cluster\" is invalid: spec.controllerConfig.annotations: Invalid value: \"object\": Annotation keys containing reserved domains 'kubernetes.io/', 'openshift.io/', or 'k8s.io/' (including subdomains like '*.kubernetes.io/') are not allowed"
    - name: Should allow annotation key similar but not matching reserved prefix
      resourceName: cluster
      initial: |
        apiVersion: operator.openshift.io/v1alpha1
        kind: ExternalSecretsConfig
        spec:
          controllerConfig:
            annotations:
              kubernetes.io.custom/test: "allowed"
              app.kubernetes.io.custom/test: "allowed"
      expected: |
        apiVersion: operator.openshift.io/v1alpha1
        kind: ExternalSecretsConfig
        spec:
          controllerConfig:
            annotations:
              kubernetes.io.custom/test: "allowed"
              app.kubernetes.io.custom/test: "allowed"
    - name: Should fail with multiple annotations when one has reserved prefix
      resourceName: cluster
      initial: |
        apiVersion: operator.openshift.io/v1alpha1
        kind: ExternalSecretsConfig
        spec:
          controllerConfig:
            annotations:
              allowed-annotation: "good"
              kubernetes.io/forbidden: "bad"
              another-allowed: "good"
      expectedError: "ExternalSecretsConfig.operator.openshift.io \"cluster\" is invalid: spec.controllerConfig.annotations: Invalid value: \"object\": Annotation keys containing reserved domains 'kubernetes.io/', 'openshift.io/', or 'k8s.io/' (including subdomains like '*.kubernetes.io/') are not allowed"
    - name: Should allow exactly 20 annotations (max limit)
      resourceName: cluster
      initial: |
        apiVersion: operator.openshift.io/v1alpha1
        kind: ExternalSecretsConfig
        spec:
          controllerConfig:
            annotations:
              annotation-1: "value-1"
              annotation-2: "value-2"
              annotation-3: "value-3"
              annotation-4: "value-4"
              annotation-5: "value-5"
              annotation-6: "value-6"
              annotation-7: "value-7"
              annotation-8: "value-8"
              annotation-9: "value-9"
              annotation-10: "value-10"
              annotation-11: "value-11"
              annotation-12: "value-12"
              annotation-13: "value-13"
              annotation-14: "value-14"
              annotation-15: "value-15"
              annotation-16: "value-16"
              annotation-17: "value-17"
              annotation-18: "value-18"
              annotation-19: "value-19"
              annotation-20: "value-20"
      expected: |
        apiVersion: operator.openshift.io/v1alpha1
        kind: ExternalSecretsConfig
        spec:
          controllerConfig:
            annotations:
              annotation-1: "value-1"
              annotation-2: "value-2"
              annotation-3: "value-3"
              annotation-4: "value-4"
              annotation-5: "value-5"
              annotation-6: "value-6"
              annotation-7: "value-7"
              annotation-8: "value-8"
              annotation-9: "value-9"
              annotation-10: "value-10"
              annotation-11: "value-11"
              annotation-12: "value-12"
              annotation-13: "value-13"
              annotation-14: "value-14"
              annotation-15: "value-15"
              annotation-16: "value-16"
              annotation-17: "value-17"
              annotation-18: "value-18"
              annotation-19: "value-19"
              annotation-20: "value-20"
    - name: Should fail with more than 20 annotations
      resourceName: cluster
      initial: |
        apiVersion: operator.openshift.io/v1alpha1
        kind: ExternalSecretsConfig
        spec:
          controllerConfig:
            annotations:
              annotation-1: "value-1"
              annotation-2: "value-2"
              annotation-3: "value-3"
              annotation-4: "value-4"
              annotation-5: "value-5"
              annotation-6: "value-6"
              annotation-7: "value-7"
              annotation-8: "value-8"
              annotation-9: "value-9"
              annotation-10: "value-10"
              annotation-11: "value-11"
              annotation-12: "value-12"
              annotation-13: "value-13"
              annotation-14: "value-14"
              annotation-15: "value-15"
              annotation-16: "value-16"
              annotation-17: "value-17"
              annotation-18: "value-18"
              annotation-19: "value-19"
              annotation-20: "value-20"
              annotation-21: "value-21"
      expectedError: "ExternalSecretsConfig.operator.openshift.io \"cluster\" is invalid: [spec.controllerConfig.annotations: Too many: 21: must have at most 20 items, <nil>: Invalid value: \"null\": some validation rules were not checked because the object was invalid; correct the existing errors to complete validation]"
    - name: Should allow empty annotations map
      resourceName: cluster
      initial: |
        apiVersion: operator.openshift.io/v1alpha1
        kind: ExternalSecretsConfig
        spec:
          controllerConfig:
            annotations: {}
      expected: |
        apiVersion: operator.openshift.io/v1alpha1
        kind: ExternalSecretsConfig
        spec:
          controllerConfig:
            annotations: {}
    - name: Should allow annotation key with special characters
      resourceName: cluster
      initial: |
        apiVersion: operator.openshift.io/v1alpha1
        kind: ExternalSecretsConfig
        spec:
          controllerConfig:
            annotations:
              custom-company.io/my_annotation.name: "allowed"
      expected: |
        apiVersion: operator.openshift.io/v1alpha1
        kind: ExternalSecretsConfig
        spec:
          controllerConfig:
            annotations:
              custom-company.io/my_annotation.name: "allowed"
    - name: Should allow annotation key that looks similar to reserved but is not
      resourceName: cluster
      initial: |
        apiVersion: operator.openshift.io/v1alpha1
        kind: ExternalSecretsConfig
        spec:
          controllerConfig:
            annotations:
              kubernetes-io/test: "allowed"
              kubernete.io/test: "allowed"
      expected: |
        apiVersion: operator.openshift.io/v1alpha1
        kind: ExternalSecretsConfig
        spec:
          controllerConfig:
            annotations:
              kubernetes-io/test: "allowed"
              kubernete.io/test: "allowed"
    - name: Should allow common third-party annotation keys
      resourceName: cluster
      initial: |
        apiVersion: operator.openshift.io/v1alpha1
        kind: ExternalSecretsConfig
        spec:
          controllerConfig:
            annotations:
              prometheus.io/scrape: "true"
              prometheus.io/port: "8080"
              argocd.argoproj.io/sync-wave: "1"
              vault.hashicorp.com/agent-inject: "true"
              cert-manager.io/cluster-issuer: "letsencrypt"
      expected: |
        apiVersion: operator.openshift.io/v1alpha1
        kind: ExternalSecretsConfig
        spec:
          controllerConfig:
            annotations:
              prometheus.io/scrape: "true"
              prometheus.io/port: "8080"
              argocd.argoproj.io/sync-wave: "1"
              vault.hashicorp.com/agent-inject: "true"
              cert-manager.io/cluster-issuer: "letsencrypt"
    - name: Should allow annotation with empty value
      resourceName: cluster
      initial: |
        apiVersion: operator.openshift.io/v1alpha1
        kind: ExternalSecretsConfig
        spec:
          controllerConfig:
            annotations:
              annotation-with-empty-value: ""
      expected: |
        apiVersion: operator.openshift.io/v1alpha1
        kind: ExternalSecretsConfig
        spec:
          controllerConfig:
            annotations:
              annotation-with-empty-value: ""
    - name: Should allow annotation key without domain prefix
      resourceName: cluster
      initial: |
        apiVersion: operator.openshift.io/v1alpha1
        kind: ExternalSecretsConfig
        spec:
          controllerConfig:
            annotations:
              simple-annotation: "value"
              cost-center: "CC-12345"
      expected: |
        apiVersion: operator.openshift.io/v1alpha1
        kind: ExternalSecretsConfig
        spec:
          controllerConfig:
            annotations:
              simple-annotation: "value"
              cost-center: "CC-12345"
    - name: Should fail with annotation key exceeding 317 characters
      resourceName: cluster
      initial: |
        apiVersion: operator.openshift.io/v1alpha1
        kind: ExternalSecretsConfig
        spec:
          controllerConfig:
            annotations:
              this-is-a-very-long-subdomain.another-segment-here.more-segments.even-more-here.and-another-one.yet-another-segment.one-more-segment.almost-there-now.final-segment-in-prefix.last-one-here.reaching-limit.exceeded-now/this-is-a-very-long-name-part-that-will-make-the-total-exceed-three-hundred-and-seventeen-characters-in-total-length-for-sure-now-yes: "test"
      expectedError: "ExternalSecretsConfig.operator.openshift.io \"cluster\" is invalid: spec.controllerConfig.annotations: Invalid value: \"object\": Annotation key name part must be no more than 63 characters"
    - name: Should fail with annotation key prefix exceeding 253 characters
      resourceName: cluster
      initial: |
        apiVersion: operator.openshift.io/v1alpha1
        kind: ExternalSecretsConfig
        spec:
          controllerConfig:
            annotations:
              this-is-a-very-long-subdomain.another-segment-here.more-segments.even-more-here.and-another-one.yet-another-segment.one-more-segment.almost-there-now.final-segment-in-prefix.last-one-here.reaching-limit.exceeded-now.and-even-more-segments-to-exceed-two-hundred-fifty-three/name: "test"
      expectedError: "ExternalSecretsConfig.operator.openshift.io \"cluster\" is invalid: spec.controllerConfig.annotations: Invalid value: \"object\": Annotation key prefix (DNS subdomain) must be no more than 253 characters"
    - name: Should fail with annotation key name part exceeding 63 characters
      resourceName: cluster
      initial: |
        apiVersion: operator.openshift.io/v1alpha1
        kind: ExternalSecretsConfig
        spec:
          controllerConfig:
            annotations:
              example.com/this-name-part-exceeds-sixty-three-characters-which-is-the-maximum-allowed: "test"
      expectedError: "ExternalSecretsConfig.operator.openshift.io \"cluster\" is invalid: spec.controllerConfig.annotations: Invalid value: \"object\": Annotation key name part must be no more than 63 characters"
    - name: Should fail with annotation key name part exceeding 63 characters without prefix
      resourceName: cluster
      initial: |
        apiVersion: operator.openshift.io/v1alpha1
        kind: ExternalSecretsConfig
        spec:
          controllerConfig:
            annotations:
              this-annotation-key-name-exceeds-sixty-three-characters-which-is-not-allowed: "test"
      expectedError: "ExternalSecretsConfig.operator.openshift.io \"cluster\" is invalid: spec.controllerConfig.annotations: Invalid value: \"object\": Annotation key name part must be no more than 63 characters"
    - name: Should fail with invalid annotation key format starting with hyphen
      resourceName: cluster
      initial: |
        apiVersion: operator.openshift.io/v1alpha1
        kind: ExternalSecretsConfig
        spec:
          controllerConfig:
            annotations:
              -invalid-start: "test"
      expectedError: "ExternalSecretsConfig.operator.openshift.io \"cluster\" is invalid: spec.controllerConfig.annotations: Invalid value: \"object\": Annotation keys must consist of alphanumeric characters, '-', '_' or '.', starting and ending with alphanumeric, with an optional lowercase DNS subdomain prefix and '/' (e.g., 'my-key' or 'example.com/my-key')"
    - name: Should fail with invalid annotation key format ending with hyphen
      resourceName: cluster
      initial: |
        apiVersion: operator.openshift.io/v1alpha1
        kind: ExternalSecretsConfig
        spec:
          controllerConfig:
            annotations:
              invalid-end-: "test"
      expectedError: "ExternalSecretsConfig.operator.openshift.io \"cluster\" is invalid: spec.controllerConfig.annotations: Invalid value: \"object\": Annotation keys must consist of alphanumeric characters, '-', '_' or '.', starting and ending with alphanumeric, with an optional lowercase DNS subdomain prefix and '/' (e.g., 'my-key' or 'example.com/my-key')"
    - name: Should fail with invalid annotation key format with invalid characters
      resourceName: cluster
      initial: |
        apiVersion: operator.openshift.io/v1alpha1
        kind: ExternalSecretsConfig
        spec:
          controllerConfig:
            annotations:
              invalid@character: "test"
      expectedError: "ExternalSecretsConfig.operator.openshift.io \"cluster\" is invalid: spec.controllerConfig.annotations: Invalid value: \"object\": Annotation keys must consist of alphanumeric characters, '-', '_' or '.', starting and ending with alphanumeric, with an optional lowercase DNS subdomain prefix and '/' (e.g., 'my-key' or 'example.com/my-key')"
    - name: Should fail with invalid annotation key prefix format
      resourceName: cluster
      initial: |
        apiVersion: operator.openshift.io/v1alpha1
        kind: ExternalSecretsConfig
        spec:
          controllerConfig:
            annotations:
              -invalid-prefix.com/name: "test"
      expectedError: "ExternalSecretsConfig.operator.openshift.io \"cluster\" is invalid: spec.controllerConfig.annotations: Invalid value: \"object\": Annotation keys must consist of alphanumeric characters, '-', '_' or '.', starting and ending with alphanumeric, with an optional lowercase DNS subdomain prefix and '/' (e.g., 'my-key' or 'example.com/my-key')"
    - name: Should allow annotation key with maximum valid name part length of 63 characters
      resourceName: cluster
      initial: |
        apiVersion: operator.openshift.io/v1alpha1
        kind: ExternalSecretsConfig
        spec:
          controllerConfig:
            annotations:
              example.com/this-is-exactly-sixty-three-characters-long-name-part1: "test"
      expected: |
        apiVersion: operator.openshift.io/v1alpha1
        kind: ExternalSecretsConfig
        spec:
          controllerConfig:
            annotations:
              example.com/this-is-exactly-sixty-three-characters-long-name-part1: "test"
    - name: Should allow componentConfigs with valid overrideEnv
      resourceName: cluster
      initial: |
        apiVersion: operator.openshift.io/v1alpha1
        kind: ExternalSecretsConfig
        spec:
          controllerConfig:
            componentConfigs:
              - componentName: ExternalSecretsCoreController
                overrideEnv:
                  - name: CUSTOM_VAR
                    value: "custom-value"
                  - name: MY_CONFIG
                    value: "test"
      expected: |
        apiVersion: operator.openshift.io/v1alpha1
        kind: ExternalSecretsConfig
        spec:
          controllerConfig:
            componentConfigs:
              - componentName: ExternalSecretsCoreController
                overrideEnv:
                  - name: CUSTOM_VAR
                    value: "custom-value"
                  - name: MY_CONFIG
                    value: "test"
    - name: Should fail with revisionHistoryLimit exceeding maximum of 50
      resourceName: cluster
      initial: |
        apiVersion: operator.openshift.io/v1alpha1
        kind: ExternalSecretsConfig
        spec:
          controllerConfig:
            componentConfigs:
              - componentName: ExternalSecretsCoreController
                deploymentConfigs:
                  revisionHistoryLimit: 51
      expectedError: "ExternalSecretsConfig.operator.openshift.io \"cluster\" is invalid: spec.controllerConfig.componentConfigs[0].deploymentConfigs.revisionHistoryLimit: Invalid value: 51: spec.controllerConfig.componentConfigs[0].deploymentConfigs.revisionHistoryLimit in body should be less than or equal to 50"
    - name: Should allow revisionHistoryLimit at maximum of 50
      resourceName: cluster
      initial: |
        apiVersion: operator.openshift.io/v1alpha1
        kind: ExternalSecretsConfig
        spec:
          controllerConfig:
            componentConfigs:
              - componentName: Webhook
                deploymentConfigs:
                  revisionHistoryLimit: 50
      expected: |
        apiVersion: operator.openshift.io/v1alpha1
        kind: ExternalSecretsConfig
        spec:
          controllerConfig:
            componentConfigs:
              - componentName: Webhook
                deploymentConfigs:
                  revisionHistoryLimit: 50
    - name: Should fail with overrideEnv starting with HOSTNAME
      resourceName: cluster
      initial: |
        apiVersion: operator.openshift.io/v1alpha1
        kind: ExternalSecretsConfig
        spec:
          controllerConfig:
            componentConfigs:
              - componentName: Webhook
                overrideEnv:
                  - name: HOSTNAME
                    value: "test"
      expectedError: "ExternalSecretsConfig.operator.openshift.io \"cluster\" is invalid: spec.controllerConfig.componentConfigs[0].overrideEnv: Invalid value: \"array\": Environment variable names with reserved prefixes 'HOSTNAME', 'KUBERNETES_', 'EXTERNAL_SECRETS_' are not allowed"
    - name: Should fail with overrideEnv starting with KUBERNETES_
      resourceName: cluster
      initial: |
        apiVersion: operator.openshift.io/v1alpha1
        kind: ExternalSecretsConfig
        spec:
          controllerConfig:
            componentConfigs:
              - componentName: CertController
                overrideEnv:
                  - name: KUBERNETES_SERVICE_HOST
                    value: "test"
      expectedError: "ExternalSecretsConfig.operator.openshift.io \"cluster\" is invalid: spec.controllerConfig.componentConfigs[0].overrideEnv: Invalid value: \"array\": Environment variable names with reserved prefixes 'HOSTNAME', 'KUBERNETES_', 'EXTERNAL_SECRETS_' are not allowed"
    - name: Should fail with overrideEnv starting with EXTERNAL_SECRETS_
      resourceName: cluster
      initial: |
        apiVersion: operator.openshift.io/v1alpha1
        kind: ExternalSecretsConfig
        spec:
          controllerConfig:
            componentConfigs:
              - componentName: BitwardenSDKServer
                overrideEnv:
                  - name: EXTERNAL_SECRETS_CONFIG
                    value: "test"
      expectedError: "ExternalSecretsConfig.operator.openshift.io \"cluster\" is invalid: spec.controllerConfig.componentConfigs[0].overrideEnv: Invalid value: \"array\": Environment variable names with reserved prefixes 'HOSTNAME', 'KUBERNETES_', 'EXTERNAL_SECRETS_' are not allowed"
    - name: Should allow componentConfigs with revisionHistoryLimit
      resourceName: cluster
      initial: |
        apiVersion: operator.openshift.io/v1alpha1
        kind: ExternalSecretsConfig
        spec:
          controllerConfig:
            componentConfigs:
              - componentName: ExternalSecretsCoreController
                deploymentConfigs:
                  revisionHistoryLimit: 5
      expected: |
        apiVersion: operator.openshift.io/v1alpha1
        kind: ExternalSecretsConfig
        spec:
          controllerConfig:
            componentConfigs:
              - componentName: ExternalSecretsCoreController
                deploymentConfigs:
                  revisionHistoryLimit: 5
    - name: Should fail with revisionHistoryLimit less than 1
      resourceName: cluster
      initial: |
        apiVersion: operator.openshift.io/v1alpha1
        kind: ExternalSecretsConfig
        spec:
          controllerConfig:
            componentConfigs:
              - componentName: Webhook
                deploymentConfigs:
                  revisionHistoryLimit: 0
      expectedError: "ExternalSecretsConfig.operator.openshift.io \"cluster\" is invalid: spec.controllerConfig.componentConfigs[0].deploymentConfigs.revisionHistoryLimit: Invalid value: 0: spec.controllerConfig.componentConfigs[0].deploymentConfigs.revisionHistoryLimit in body should be greater than or equal to 1"
    - name: Should allow multiple componentConfigs for different components
      resourceName: cluster
      initial: |
        apiVersion: operator.openshift.io/v1alpha1
        kind: ExternalSecretsConfig
        spec:
          controllerConfig:
            componentConfigs:
              - componentName: ExternalSecretsCoreController
                overrideEnv:
                  - name: CUSTOM_CONTROLLER_VAR
                    value: "controller-value"
              - componentName: Webhook
                deploymentConfigs:
                  revisionHistoryLimit: 3
              - componentName: CertController
                overrideEnv:
                  - name: CERT_VAR
                    value: "cert-value"
      expected: |
        apiVersion: operator.openshift.io/v1alpha1
        kind: ExternalSecretsConfig
        spec:
          controllerConfig:
            componentConfigs:
              - componentName: ExternalSecretsCoreController
                overrideEnv:
                  - name: CUSTOM_CONTROLLER_VAR
                    value: "controller-value"
              - componentName: Webhook
                deploymentConfigs:
                  revisionHistoryLimit: 3
              - componentName: CertController
                overrideEnv:
                  - name: CERT_VAR
                    value: "cert-value"
  onUpdate:
    - name: Should be able to update labels in controller config
      resourceName: cluster
      initial: |
        apiVersion: operator.openshift.io/v1alpha1
        kind: ExternalSecretsConfig
        spec:
          controllerConfig:
            labels:
              "app": "external-secrets"
      updated: |
        apiVersion: operator.openshift.io/v1alpha1
        kind: ExternalSecretsConfig
        spec:
          controllerConfig:
            labels:
              "app": "external-secrets"
              "version": "v1.0.0"
      expected: |
        apiVersion: operator.openshift.io/v1alpha1
        kind: ExternalSecretsConfig
        spec:
          controllerConfig:
            labels:
              "app": "external-secrets"
              "version": "v1.0.0"
    - name: Should not be able to change cert-manager enabled after creation
      resourceName: cluster
      initial: |
        apiVersion: operator.openshift.io/v1alpha1
        kind: ExternalSecretsConfig
        spec:
          controllerConfig:
            certProvider:
              certManager:
                mode: Disabled
      updated: |
        apiVersion: operator.openshift.io/v1alpha1
        kind: ExternalSecretsConfig
        spec:
          controllerConfig:
            certProvider:
              certManager:
                mode: Enabled
                issuerRef:
                  name: "letsencrypt-issuer"
                  kind: "ClusterIssuer"
                  group: "cert-manager.io"
      expectedError: "ExternalSecretsConfig.operator.openshift.io \"cluster\" is invalid: spec.controllerConfig.certProvider.certManager.mode: Invalid value: \"string\": mode is immutable once set"
    - name: Should not be able to change issuerRef after creation
      resourceName: cluster
      initial: |
        apiVersion: operator.openshift.io/v1alpha1
        kind: ExternalSecretsConfig
        spec:
          controllerConfig:
            certProvider:
              certManager:
                mode: Enabled
                issuerRef:
                  name: "old-issuer"
                  kind: "ClusterIssuer"
                  group: "cert-manager.io"
      updated: |
        apiVersion: operator.openshift.io/v1alpha1
        kind: ExternalSecretsConfig
        spec:
          controllerConfig:
            certProvider:
              certManager:
                mode: Enabled
                issuerRef:
                  name: "new-issuer"
                  kind: "ClusterIssuer"
                  group: "cert-manager.io"
      expectedError: "ExternalSecretsConfig.operator.openshift.io \"cluster\" is invalid: spec.controllerConfig.certProvider.certManager.issuerRef: Invalid value: \"object\": issuerRef is immutable once set"
    - name: Should be able to add bitwarden provider after creation
      resourceName: cluster
      initial: |
        apiVersion: operator.openshift.io/v1alpha1
        kind: ExternalSecretsConfig
        spec:
          appConfig: {}
      updated: |
        apiVersion: operator.openshift.io/v1alpha1
        kind: ExternalSecretsConfig
        spec:
          appConfig: {}
          plugins:
            bitwardenSecretManagerProvider:
              mode: Enabled
              secretRef:
                name: "bitwarden-certs"
      expected: |
        apiVersion: operator.openshift.io/v1alpha1
        kind: ExternalSecretsConfig
        spec:
          appConfig:
            logLevel: 1
          plugins:
            bitwardenSecretManagerProvider:
              mode: Enabled
              secretRef:
                name: "bitwarden-certs"
